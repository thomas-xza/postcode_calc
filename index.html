<!DOCTYPE html>

<html>

<head>

<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link rel="stylesheet" href="./css/normalize.css">

<link rel="stylesheet" href="./css/stylize.css">

<title>location calculator</title>

</head>

<body>


<script type="importmap">
  {
    "imports": {
      "vue": "https://unpkg.com/vue@3/dist/vue.esm-browser.js"
    }
  }
</script>


<script type="module">
import { createApp, ref } from 'vue'

createApp({
  setup() {

      const test = ref(0);

      const origins = ref('SW1A 0AA\n' +
			  'WC2A 2LL\n' +
			  'EC4M 8AD');
      
      const dests = ref('N1 9AL, Kings Cross St. Pancras\n' +
			'EH1 1BB, Edinburgh Waverley');

      const status = ref(0);



      
      function find_distances () {

	  status.value = 1;

	  const [origin_objs, dest_objs] = setup_data_structs();

	  const coord_origin_objs = coords_via_api(origin_objs);

	  const coord_dest_objs = coords_via_api(dest_objs);

	  console.log(coord_origin_objs);

	  console.log(coord_dest_objs);

	  status.value = 2;

      };
      
      
      async function coords_via_api(location_objs) {

	  console.log(location_objs[0]);

	  const fetches = location_objs.map(fetch_data);

	  const new_location_objs = await Promise.all(fetches);

	  console.log('this should be last');

	  console.log(new_location_objs);

	  return new_location_objs;

      };
      

      async function fetch_data(location_obj, index) {

	  const url = postcode_to_url(location_obj['postcode']);

	  const mapbox_res = await fetch(url);
	  
	  const mapbox_json = await mapbox_res.json();

	  const top_hit_coords = mapbox_json.features[0].geometry.coordinates;

	  location_obj['long'] = top_hit_coords[0];

	  location_obj['lat'] = top_hit_coords[1];

	  console.log(index + 'finished');

	  return location_obj;

      };

      
      function postcode_to_url(postcode) {

          //  Note: limit as of 2023-04 is 600 geocode requests/minute
	  //  https://docs.mapbox.com/api/overview/

	  const mapbox_api_key = 'pk.eyJ1IjoidGVzdC14emEiLCJhIjoiY2xnOXNiaWRvMWFtcDNlcWxzZjRmZDdldSJ9.lKZ_CDvdIh1Y9dw2DGjbOA';

	  return 'https://api.mapbox.com/geocoding/v5/mapbox.places/' +
	      postcode + ', United Kingdom.json?access_token=' +
	      mapbox_api_key;

      };
      

      function setup_data_structs() {

	  const origin_array = origins.value.trim().split('\n');

	  const dest_array = dests.value.trim().split('\n');

	  const origin_objs = origin_array.map(

	      postcode => {
		  
		  return { 'postcode': postcode }
		  
	      }

	  );

	  
	  const dest_objs = dest_array.map(

	      item => {

		  const postcode = item.split(',')[0];

		  const name = item.split(',')[1];

		  return { 'postcode': postcode,
			   'name': name }
		  
	      }

	  );

	  return [origin_objs, dest_objs];

      }

    
    return {
	test,
	origins,
	dests,
	status,
	find_distances
    }
  }
}).mount('#app')
</script>


<div id="app">

  {{ test }}

  Origins:<br>
  <textarea v-model="origins"></textarea><br>
  Note: max conversions to co-ordinates per minute is 600 (Mapbox API)
  
  <br><br>
  
  Destinations:<br>
  <textarea v-model="dests"></textarea><br>
  Note: please only 1 comma (,) per line else there are errors

  <br><br>

  <button @click="find_distances" v-if="status === 0">Calculate distances from origins to destinations</button>
  <p v-else-if="status === 1">Part 1: Finding co-ordinates of postcodes...</p>
  <p v-else-if="status === 2">Part 2: Finding distances between source and destination co-ordinates...</p>

</div>


</body>

</html>
